#
# Backend VCL file - this should be auto-generated by consul
#

{{range service "varnish"}}
backend httpd_{{.Node | replaceAll "-" "_"}} {
    .host = "{{.Address}}";
    .port = "81";
}{{end}}
{{range service "varnish"}}
backend varnish_{{.Node | replaceAll "-" "_"}} {
  .host = "{{.Address}}";
  .port = "{{.Port}}";
}{{end}}

sub backend_init {
  ## setup varnish backend hash director
  new varnish_backend = directors.hash();
  {{range service "varnish"}}varnish_backend.add_backend(varnish_{{.Node | replaceAll "-" "_"}}, 1.0);{{end}}

  ## setup actual backend director, using round-robin
  new httpd_backend = directors.round_robin();
  {{range service "varnish"}}httpd_backend.add_backend(httpd_{{.Node | replaceAll "-" "_"}});{{end}}
}
